# 异常处理
## 异常的产生
### 异常分类

异常主要分为两类：
* 业务异常: 指系统开发时已经预知的异常，比如业务逻辑异常，数据校验异常、权限异常等，其中数据校验异常、权限异常通常在切面中进行处理，而业务异常则在各个服务实现中编写。
* 运行异常: 指系统运行时遇到的异常，如空指针异常、除以零异常等。

### 异常接口
业务逻辑异常类BusinessException的相关接口为
```
public BusinessException();
public BusinessException(String messageKey, Object arg);
public BusinessException(String messageKey, Object[] args);
public BusinessException(String messageKey, boolean isResource); 
```
其中的messageKey即为异常代码，通常为一个字符串，如PhoneIncorrect、NotFoundUser等

-----

注意：不建议使用isResource为false的方法。

## 异常的处理原则 

处理原则
* 直接throw业务异常，尽量避免try catch处理逻辑
* 避免使用try catch的话，对出现的异常也需要精细化处理，不能只是简单的打印出一段堆栈，而程序还能继续执行，这样对系统来说可能是破坏性的
* 无法准确处理的异常，不要处理，直接交由统一异常处理来进行。 

## 异常的返回数据格式 
表现为JSON数据，对应ApiResponse。
其中status对应异常类型，
* -1 未分类异常
* -2 业务异常 
* -3 数据校验异常 
* -4 权限异常 

statusText对应异常信息：格式为"错误消息编码：错误消息明细"
data用于传递自定义信息，通常传递异常堆栈信息

## 统一异常处理机制
利用Spring的异常处理机制实现，提供默认异常信息处理实现，并支持自定义异常信息处理。


#### 处理异常类GlobalExceptionHandler
对应类为ins.framework.web.advice.GlobalExceptionHandler，相关代码如下：
```
@Slf4j
@ControllerAdvice
public class GlobalExceptionHandler {
	@ExceptionHandler(value = Exception.class)
	@ResponseBody
	public ApiResponse<Object> defaultErrorHandler(HttpServletRequest request, Exception ex) throws Exception {
		if (AnnotationUtils.findAnnotation(ex.getClass(), ResponseStatus.class) != null) {
			throw ex;
		}

		return Springs.getBean(ExceptionHelper.class).processException(ex);

	}
}
```
该类将捕获所有异常，并获取ExceptionHelper接口的实例进行解析。

### ExceptionHelper接口
对应类为ins.framework.web.exception.ExceptionHelper，相关代码如下：
```
public interface ExceptionHelper {
	public ApiResponse<Object> processException(Exception ex);
}

```

### DefaultExceptionHelper默认异常处理工具类

对应类为ins.framework.web.exception.DefaultExceptionHelper，用于简化自定义异常处理。相关代码如下：
```
public class DefaultExceptionHelper {
	public static Object processData(Exception ex) {
		return ExceptionUtils.getStackTrace(ex);
	}
    public static int processStatusCode(Exception ex) {
        ...
    }
    public static String processMessageKey(Exception ex) {
        ...
    }
}

```
#### DefaultExceptionConfig默认异常实现
该配置类提供默认异常信息处理实现，实例代码如下：
对应类为ins.framework.web.exception.DefaultExceptionConfig，相关代码如下：
```
@Configuration
@Slf4j
public class DefaultExceptionConfig {
	@Autowired
	private LocaleMessageService localeMessageService;

	@Bean
	public ExceptionHelper condition() {
		return ex -> {
			long status = DefaultExceptionHelper.processStatusCode(ex);
			String messageKey = DefaultExceptionHelper.processMessageKey(ex);
			String message;
			// 根据键值对获取信息
			try {
				//默认返回格式为"错误消息编码：错误消息明细"
				message = messageKey + ":" + localeMessageService.getMessage(messageKey);
			} catch (Exception e) {
				log.error("{}", e);
				message = messageKey;
			}
			Object data = DefaultExceptionHelper.processData(ex);
			return new ApiResponse<>(status, message, data);
		};
	}

}

```
注意：这里引用了框架提供的服务LocaleMessageService，用于获取国际化信息。

### 添加异常消息配置文件
异常消息配置文件全部放到src/main/resources/i18n中，且前缀为exception。示例文件名如下：
* 简体中文: exception_zh_CN.properties
* 繁体中文: exception_zh_TW.properties
* 美国英语: exception_en_US.properties
* 缺省: exception.properties(通常其内容和美国英语保持一致)

exception_en_US.properties文件示例内容如下：
```
AccessDenied = Access denied

DateFormatIncorrect = The date format is incorrect

DevideByZero = Devide by zero

ExpiredToken = Expired or invalid JWT token

NumberFormatIncorrect = The number format is incorrect

```
exception_zh_CN.properties文件示例内容如下：
```
#Generated by ResourceBundle Editor (http://essiembre.github.io/eclipse-rbe/)

AccessDenied = \u7981\u6B62\u8BBF\u95EE

DateFormatIncorrect = \u65E5\u671F\u683C\u5F0F\u4E0D\u5BF9

DevideByZero = \u9664\u4EE5\u96F6\u9519\u8BEF

ExpiredToken = \u8FC7\u671F\u6216\u975E\u6CD5JWT\u4EE4\u724C

NumberFormatIncorrect = \u6570\u503C\u683C\u5F0F\u4E0D\u5BF9
```

### 修改application.yml配置（实际配置在apollo中）
异常消息配置文件全部放到src/main/resources/i18n中，且前缀为exception,所以需要修改application.yml配置文件，设定basename: i18n/messages,i18n/exception。注意messages是默认消息、exception是我们自定义的异常消息
```
spring:
  messages:
    basename: i18n/messages,i18n/exception #指定message的basename，多个以逗号分隔，如果不加包名的话，默认从classpath路径开始，默认: messages
    cache-seconds: -1 #设定加载的资源文件缓存失效时间，-1的话为永不过期，默认为-1
    encoding: UTF-8 #设定Message bundles的编码，默认: UTF-8
```    
## 常见问题
### 自定义异常信息处理实现
自行实现配置类，注意@ConditionalOnBean(DefaultExceptionConfig.class)。实例相关代码如下：

```
@Configuration
@ConditionalOnBean(DefaultExceptionConfig.class)
@Slf4j
public class ExceptionConfig {

	@Autowired
	private LocaleMessageService localeMessageService;

	@Bean
	public ExceptionHelper condition() {
		return ex -> {
			long status = DefaultExceptionHelper.processStatusCode(ex);
			String messageKey = DefaultExceptionHelper.processMessageKey(ex);
			String message;
			// 根据键值对获取信息
			try {
				//默认返回格式为"错误消息编码：错误消息明细"
				message = messageKey + ":" + localeMessageService.getMessage(messageKey);
			} catch (Exception e) {
				log.error("{}", e);
				message = messageKey;
			}

			// 这里使用自定义的处理方法
			Object data = processData(ex);
			return new ApiResponse<>(status, message, data);
		};
	}

	private Object processData(Exception ex) { 
        //啥也不干，直接返回空串
		return "";
	}
}


```
这个例子只是把data部分设置为空，其他部分还是用的默认的值，也可以参考默认的方式完全自定义。
